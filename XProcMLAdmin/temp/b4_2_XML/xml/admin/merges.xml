<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="merges.css" type="text/css" charset="UTF-8"?>
<XML>
<TITLE> </TITLE><Heading-1>
<A ID="pgfId-1047449"></A>
<A ID="83498"></A>
Understanding and Controlling Database Merges</Heading-1>
<pagenum>
<A ID="pgfId-1047453"></A>
152</pagenum>
<Body>
<A ID="pgfId-1038118"></A>
This chapter describes database merges and how you can control them. It includes the following sections:</Body>
<Body-bullet>
<A ID="pgfId-1046284"></A>
<A href="merges.xml#id(43904)" xml:link="simple" show="replace" actuate="user" CLASS="XRef"><Hyperlink>
Overview of Merges: Merges are Good</Hyperlink>
</A></Body-bullet>
<Body-bullet>
<A ID="pgfId-1046292"></A>
<A href="merges.xml#id(38312)" xml:link="simple" show="replace" actuate="user" CLASS="XRef"><Hyperlink>
Setting Merge Policy</Hyperlink>
</A></Body-bullet>
<Body-bullet>
<A ID="pgfId-1046297"></A>
<A href="merges.xml#id(12834)" xml:link="simple" show="replace" actuate="user" CLASS="XRef"><Hyperlink>
Blackout Periods for Merges</Hyperlink>
</A></Body-bullet>
<Body-bullet>
<A ID="pgfId-1046302"></A>
<A href="merges.xml#id(55318)" xml:link="simple" show="replace" actuate="user" CLASS="XRef"><Hyperlink>
Merges and Point-In-Time Queries</Hyperlink>
</A></Body-bullet>
<Body-bullet>
<A ID="pgfId-1047249"></A>
<A href="merges.xml#id(89673)" xml:link="simple" show="replace" actuate="user" CLASS="XRef"><Hyperlink>
Monitoring a Merge</Hyperlink>
</A></Body-bullet>
<Body-bullet>
<A ID="pgfId-1046531"></A>
<A href="merges.xml#id(14662)" xml:link="simple" show="replace" actuate="user" CLASS="XRef"><Hyperlink>
Explicit Merge Commands</Hyperlink>
</A></Body-bullet>
<Body-bullet>
<A ID="pgfId-1046307"></A>
<A href="merges.xml#id(66176)" xml:link="simple" show="replace" actuate="user" CLASS="XRef"><Hyperlink>
Configuring Merge Policy Rules</Hyperlink>
</A></Body-bullet>
<Heading-2>
<A ID="pgfId-1045856"></A>
<A ID="43904"></A>
Overview of Merges: Merges are Good</Heading-2>
<Body>
<A ID="pgfId-1046320"></A>
This section provides an overview of merges, and includes the following parts:</Body>
<Body-bullet>
<A ID="pgfId-1046340"></A>
<A href="merges.xml#id(58175)" xml:link="simple" show="replace" actuate="user" CLASS="XRef"><Hyperlink>
Dynamic and Self-Tuning</Hyperlink>
</A></Body-bullet>
<Body-bullet>
<A ID="pgfId-1046401"></A>
<A href="merges.xml#id(65931)" xml:link="simple" show="replace" actuate="user" CLASS="XRef"><Hyperlink>
What Happens During a Merge</Hyperlink>
</A></Body-bullet>
<Body-bullet>
<A ID="pgfId-1046348"></A>
<A href="merges.xml#id(81641)" xml:link="simple" show="replace" actuate="user" CLASS="XRef"><Hyperlink>
Dangers of Disabling Merges</Hyperlink>
</A></Body-bullet>
<Body-bullet>
<A ID="pgfId-1046353"></A>
<A href="merges.xml#id(13269)" xml:link="simple" show="replace" actuate="user" CLASS="XRef"><Hyperlink>
Merges Will Change Scores</Hyperlink>
</A></Body-bullet>
<Heading-3>
<A ID="pgfId-1045858"></A>
<A ID="58175"></A>
Dynamic and Self-Tuning</Heading-3>
<Body>
<A ID="pgfId-1046361"></A>
Merges are a way of self-tuning the performance of the system, and MarkLogic Server continuously assesses the state of each database to see if it would benefit from self-tuning through a merge. In most cases, the default merge settings and the dynamic nature of merges will keep the database tuned optimally at all times. Because merges can be resource intensive (both disk I/O and CPU), however, some DBAs might need to control when merges occur and/or when they do not occur. You can do that by setting your merge policy as appropriate for your environment, as described in <A href="merges.xml#id(38312)" xml:link="simple" show="replace" actuate="user" CLASS="XRef">'Setting Merge Policy' on page&#160;140</A>. </Body>
<Body>
<A ID="pgfId-1046362"></A>
Dynamic and self-tuning, merges are a 'good thing'; they not only reclaim disk space, but improve the query and search performance of the system. Databases are made up of one or more forests, and forests are made up of one or more <Emphasis>
stands</Emphasis>
. The more stands there are in a forest, the more time it takes to resolve a query. Merges reduce the number of stands in each forest in a database, thereby improving the time it takes to resolve queries.</Body>
<Heading-3>
<A ID="pgfId-1045873"></A>
<A ID="65931"></A>
What Happens During a Merge</Heading-3>
<Body>
<A ID="pgfId-1046405"></A>
A database consists of one or more forests, and each forest consists of one or more stands. Each stand consists of one or more fragments. When a document is updated, new versions of all of the fragments associated with the document update are created in a new stand. Any old versions of the fragment remain in the old stand with a system timestamp that lets MarkLogic Server know that they are old versions of the fragments. Similarly, when a document is deleted, its fragments remain in the old stand with a system timestamp that lets MarkLogic Server know that they are old versions of the fragments.</Body>
<Body>
<A ID="pgfId-1045874"></A>
Merges occur to move any unchanged fragments from an old stand into a new stand, deleting any old versions of fragments (including deleted fragments), thereby freeing up disk space and compacting the usable fragments so they are all together on disk. Additionally, merges combine index data for all of the fragments in a stand, thereby optimizing the indexes. Merges are a normal part of database operation, and they ensure that the system continues to perform at its best as updates and deletes occur. </Body>
<Body>
<A ID="pgfId-1046426"></A>
To summarize, as part of merging, the following occurs:</Body>
<Body-bullet>
<A ID="pgfId-1046419"></A>
Multiple stands are combined into one for improved performance.</Body-bullet>
<Body-bullet>
<A ID="pgfId-1045875"></A>
Disk space is reclaimed. </Body-bullet>
<Body-bullet>
<A ID="pgfId-1045859"></A>
Indexes and lexicons are combined and re-optimized based on their new size.</Body-bullet>
<Body>
<A ID="pgfId-1046444"></A>
The result is a database that is smaller and can resolve queries much faster than before the merge.</Body>
<Heading-3>
<A ID="pgfId-1045840"></A>
<A ID="81641"></A>
Dangers of Disabling Merges</Heading-3>
<Body>
<A ID="pgfId-1045844"></A>
MarkLogic Server is designed to periodically merge. Although there is a control to disable merges, it is dangerous to leave merges disabled on a database when there is a lot of updates occurring to the system. While disabling merges might eliminate some contention for resources during periods where merges and other requests are simultaneously occurring on the system, the performance of MarkLogic Server will degrade over time if merges not allowed to proceed when changes (inserts, updates, deletes) are made to the database. </Body>
<Body>
<A ID="pgfId-1046470"></A>
Furthermore, disabling or eliminating merging may eventually lead to a condition in which the server is unable to make changes to the database. For example, when an in-memory stands fills up, it is written to an on-disk stand. MarkLogic Server has a fixed limit for the maximum number of stands (64), and eventually, that limit will occur and you will no longer be able to update your system.</Body>
<Body>
<A ID="pgfId-1046476"></A>
In most cases where merges are causing disruptions to your system, you should be able to adjust the merge policy parameters to settings that will work in your environment. If you do need to disable merges, however, be sure to monitor the system and make sure the number of stands per forest does not grow too high. For details on setting merge controls, see <A href="merges.xml#id(55008)" xml:link="simple" show="replace" actuate="user" CLASS="XRef">'Description on Merge Parameters' on page&#160;141</A> and <A href="merges.xml#id(66176)" xml:link="simple" show="replace" actuate="user" CLASS="XRef">'Configuring Merge Policy Rules' on page&#160;148</A>. </Body>
<Body>
<A ID="pgfId-1051027"></A>
In some cases, especially in environments with many forests and constantly changing content across many of the forests, an alternative to disabling merges is to set one or more forests to be delete-only. For details, see <A href="forests.xml#id(85362)" xml:link="simple" show="replace" actuate="user" CLASS="XRef">'Making a Forest Delete-Only' on page&#160;176</A>.</Body>
<Heading-3>
<A ID="pgfId-1045667"></A>
<A ID="13269"></A>
Merges Will Change Scores</Heading-3>
<Body>
<A ID="pgfId-1045949"></A>
When a database merges, it deletes old fragments that exist in the database, therefore changing (making it smaller) the total number of fragments in the database. Because the number of fragments in the database is used in determining the score for a <code>
cts:search</code>
 operation, merges will have an impact on search scores, which in turn might impact the order of search results (which are ordered by relevance score). </Body>
<Body>
<A ID="pgfId-1046486"></A>
The amount of impact that merges have on scores is dependent on how many old versions of fragments there are waiting to be merged, the content of the old fragments, and the overall size of the database. For large databases with relatively little amount of change, the difference in the scores will be very small. For smaller databases with large amount of change, the differences in scores can be significant before and after a merge completes.</Body>
<Heading-2>
<A ID="pgfId-1045945"></A>
<A ID="38312"></A>
Setting Merge Policy</Heading-2>
<Body>
<A ID="pgfId-1046195"></A>
This section describes the tools you can use to control merges, and has the following parts:</Body>
<Body-bullet>
<A ID="pgfId-1046271"></A>
<A href="merges.xml#id(73151)" xml:link="simple" show="replace" actuate="user" CLASS="XRef"><Hyperlink>
Overview of the Merge Policy Controls</Hyperlink>
</A></Body-bullet>
<Body-bullet>
<A ID="pgfId-1046279"></A>
<A href="merges.xml#id(55008)" xml:link="simple" show="replace" actuate="user" CLASS="XRef"><Hyperlink>
Description on Merge Parameters</Hyperlink>
</A></Body-bullet>
<Body>
<A ID="pgfId-1051044"></A>
In some cases, especially in environments with many forests and constantly changing content across many of the forests, another tool for setting merge policy is to set one or more forests to be delete-only (<code>
updates allowed</code>
 set to <code>
false</code>
). For details, see <A href="forests.xml#id(85362)" xml:link="simple" show="replace" actuate="user" CLASS="XRef">'Making a Forest Delete-Only' on page&#160;176</A>.</Body>
<Heading-3>
<A ID="pgfId-1046196"></A>
<A ID="73151"></A>
Overview of the Merge Policy Controls</Heading-3>
<Body>
<A ID="pgfId-1046200"></A>
If you determine that you need to manage your merges, there are several types of controls to help you manage the conditions in which merges occur:</Body>
<Body-bullet>
<A ID="pgfId-1046182"></A>
The following controls determine the conditions under which MarkLogic Server deems a merge is desirable:</Body-bullet>
<Body-bullet-2>
<A ID="pgfId-1046183"></A>
<code>
merge min size</code>
 </Body-bullet-2>
<Body-bullet-2>
<A ID="pgfId-1046184"></A>
<code>
merge min ratio</code>
 </Body-bullet-2>
<Body-bullet>
<A ID="pgfId-1046185"></A>
The following controls determine the conditions under which a merge will be allowed: </Body-bullet>
<Body-bullet-2>
<A ID="pgfId-1046186"></A>
<code>
merge max size</code>
 </Body-bullet-2>
<Body-bullet-2>
<A ID="pgfId-1046187"></A>
<code>
merge enable</code>
 </Body-bullet-2>
<Body-bullet-2>
<A ID="pgfId-1046188"></A>
merge blackout periods </Body-bullet-2>
<Body-bullet>
<A ID="pgfId-1046189"></A>
The following control determines if multiple versions of fragments are preserved when a merge is performed: </Body-bullet>
<Body-bullet-2>
<A ID="pgfId-1046190"></A>
<code>
merge timestamp</code>
</Body-bullet-2>
<Body-bullet>
<A ID="pgfId-1045937"></A>
The following controls explicitly initiate a merge (see <A href="merges.xml#id(23498)" xml:link="simple" show="replace" actuate="user" CLASS="XRef">'Manually Initiating a Merge' on page&#160;147</A>):</Body-bullet>
<Body-bullet-2>
<A ID="pgfId-1046248"></A>
<code>
xdmp:merge()</code>
</Body-bullet-2>
<Body-bullet-2>
<A ID="pgfId-1046710"></A>
The merge button in Admin Interface.</Body-bullet-2>
<Body-bullet>
<A ID="pgfId-1046256"></A>
The Admin Interface has controls for cancelling a merge (see <A href="merges.xml#id(60776)" xml:link="simple" show="replace" actuate="user" CLASS="XRef">'Cancelling a Merge' on page&#160;148</A>).</Body-bullet>
<Body>
<A ID="pgfId-1046731"></A>
For more information on how set up your system to better control merges, see <A href="merges.xml#id(66176)" xml:link="simple" show="replace" actuate="user" CLASS="XRef">'Configuring Merge Policy Rules' on page&#160;148</A>.</Body>
<Heading-3>
<A ID="pgfId-1046131"></A>
<A ID="55008"></A>
Description on Merge Parameters</Heading-3>
<Body>
<A ID="pgfId-1046265"></A>
The following table describes the settings available on the Databases &gt; <Emphasis>
db_name</Emphasis>
 &gt;Merge Policy page of the Admin Interface. These parameters determine when automatic merges occur on a database, as well as other administrative functions.</Body>
<TableAnchor>
<A ID="pgfId-1046152"></A>
</TableAnchor>
<TABLE>
<ROW>
<TH ROWSPAN="1" COLSPAN="1">
<CellHeading>
<A ID="pgfId-1046094"></A>
Database Setting</CellHeading>
</TH>
<TH ROWSPAN="1" COLSPAN="1">
<CellHeading>
<A ID="pgfId-1046096"></A>
Description</CellHeading>
</TH>
</ROW>
<ROW>
<CELL ROWSPAN="1" COLSPAN="1">
<CellBody>
<A ID="pgfId-1047369"></A>
<code>
merge enable</code>
</CellBody>
</CELL>
<CELL ROWSPAN="1" COLSPAN="1">
<CellBody>
<A ID="pgfId-1047371"></A>
Allows merges to occur. Set this to false to disable merges for the database. Use care when setting this to false, as merges are ultimately required for the system to maintain performance levels and to allow optimized updates to the system.</CellBody>
</CELL>
</ROW>
<ROW>
<CELL ROWSPAN="1" COLSPAN="1">
<CellBody>
<A ID="pgfId-1057247"></A>
<code>
merge priority</code>
</CellBody>
</CELL>
<CELL ROWSPAN="1" COLSPAN="1">
<CellBody>
<A ID="pgfId-1057249"></A>
Specifies the CPU scheduler priority at which merges should run. The settings are: </CellBody>
<Body-bullet>
<A ID="pgfId-1057277"></A>
<code>
normal</code>
 specifies the same CPU scheduler priority as for requests. </Body-bullet>
<Body-bullet>
<A ID="pgfId-1057302"></A>
<code>
lower</code>
 specifies a lower CPU scheduler priority than for requests.</Body-bullet>
</CELL>
</ROW>
<ROW>
<CELL ROWSPAN="1" COLSPAN="1">
<CellBody>
<A ID="pgfId-1047377"></A>
<code>
merge max size</code>
</CellBody>
</CELL>
<CELL ROWSPAN="1" COLSPAN="1">
<CellBody>
<A ID="pgfId-1047379"></A>
The maximum size, in megabytes, of a stand that will result from a merge. If a stand grows beyond the specified size, it will not be merged. If two stands would be larger than the specified size if merged, they will not be merged together. If you set this to smaller sizes, large merges (which may require more disk and CPU resources) will be prevented. Set this to 0 (the default) to allow any sized stand to merge. Use care when setting this to a non-zero value, as this can prevent merges which are ultimately required for the system to maintain performance levels and to allow optimized updates to the system. </CellBody>
</CELL>
</ROW>
<ROW>
<CELL ROWSPAN="1" COLSPAN="1">
<CellBody>
<A ID="pgfId-1046098"></A>
<code>
merge min size</code>
</CellBody>
</CELL>
<CELL ROWSPAN="1" COLSPAN="1">
<CellBody>
<A ID="pgfId-1046100"></A>
The minimum number of fragments that a stand can contain. Two or more stands with fewer than this number of fragments are automatically merged. </CellBody>
</CELL>
</ROW>
<ROW>
<CELL ROWSPAN="1" COLSPAN="1">
<CellBody>
<A ID="pgfId-1046102"></A>
<code>
merge min ratio</code>
</CellBody>
</CELL>
<CELL ROWSPAN="1" COLSPAN="1">
<CellBody>
<A ID="pgfId-1046104"></A>
A positive integer indicating the minimum ratio between the number fragments in a stand and the number of fragments in all of the other smaller stands (that is stands with fewer fragments) in the forest. Stands with a fragment count below this ratio relative to all smaller stands are automatically merged with the smaller stands. For an example, see <A href="merges.xml#id(39419)" xml:link="simple" show="replace" actuate="user" CLASS="XRef">'If You Want to Reduce the Number of ‘Large' Merges' on page&#160;149</A>.</CellBody>
</CELL>
</ROW>
<ROW>
<CELL ROWSPAN="1" COLSPAN="1">
<CellBody>
<A ID="pgfId-1046106"></A>
<code>
merge timestamp</code>
</CellBody>
</CELL>
<CELL ROWSPAN="1" COLSPAN="1">
<CellBody>
<A ID="pgfId-1046108"></A>
The timestamp stored on merged stands. This is used for point-in-time queries, and determines when space occupied by deleted fragments and old versions of fragments may be reclaimed by the database. If a fragment is deleted or updated at a time after the merge timestamp, then the old version of the fragment is retained for use in point-in-time queries. Set this to 0 (the default) to let the system reclaim the maximum amount of disk space during merge activities. A setting of 0 will remove all deleted and updated fragments when a merge occurs. Set this to 1 before loading or updating any content to create a complete archive of the changes to the database over time. Set this to the current timestamp to preserve all versions of content from this point on. The timestamp is a number maintained by MarkLogic Server that increments every time a change occurs in any of the databases in a system (including configuration changes from any host in a cluster). To set to the current timestamp, click the <code>
current timestamp</code>
 button; the timestamp is displayed in red until you press OK to activate the timestamp for future merges. For details on point-in-time queries, see the <Emphasis>
Application Developer's Guide</Emphasis>
.</CellBody>
</CELL>
</ROW>
<ROW>
<CELL ROWSPAN="1" COLSPAN="1">
<CellBody>
<A ID="pgfId-1046128"></A>
<code>
merge blackout periods</code>
</CellBody>
</CELL>
<CELL ROWSPAN="1" COLSPAN="1">
<CellBody>
<A ID="pgfId-1046130"></A>
Specify times when merges are disabled. To specify a merge blackout period, click the Create tab and specify when you want the blackout to occur. You can make it a recurring blackout period, or specify a one-time blackout period. Use caution when setting large blackout periods when there are significant updates occurring on the system; merges are a normal part of the self-tuning mechanism of the database, and disabling them completely or for long periods of time can cause performance degradation.</CellBody>
</CELL>
</ROW>
</TABLE>
<Heading-2>
<A ID="pgfId-1045928"></A>
<A ID="12834"></A>
Blackout Periods for Merges</Heading-2>
<Body>
<A ID="pgfId-1045701"></A>
Although merges are a normal part of system behavior, there are times when it is inconvenient for a merge to start. Merge blackout periods allow you to specify times when a merge should not begin. This section describes merge blackouts and includes the following parts:</Body>
<Body-bullet>
<A ID="pgfId-1047126"></A>
<A href="merges.xml#id(81186)" xml:link="simple" show="replace" actuate="user" CLASS="XRef"><Hyperlink>
Understanding Merge Blackouts</Hyperlink>
</A></Body-bullet>
<Body-bullet>
<A ID="pgfId-1047130"></A>
<A href="merges.xml#id(64592)" xml:link="simple" show="replace" actuate="user" CLASS="XRef"><Hyperlink>
Configuring Merge Blackout Periods</Hyperlink>
</A></Body-bullet>
<Body-bullet>
<A ID="pgfId-1047244"></A>
<A href="merges.xml#id(23342)" xml:link="simple" show="replace" actuate="user" CLASS="XRef"><Hyperlink>
Deleting Merge Blackout Periods</Hyperlink>
</A></Body-bullet>
<Heading-3>
<A ID="pgfId-1047131"></A>
<A ID="81186"></A>
Understanding Merge Blackouts</Heading-3>
<Body>
<A ID="pgfId-1046741"></A>
A merge blackout is a predetermined time period in which automatic merges are disabled. A Merge that starts before a merge blackout period will continue until either it completes or until it is canceled, even if the merge continues into a blackout period. If you want to stop any merges at the beginning of a blackout period, you must cancel them manually as described in <A href="merges.xml#id(60776)" xml:link="simple" show="replace" actuate="user" CLASS="XRef">'Cancelling a Merge' on page&#160;148</A>. Because merges that start just before a blackout period will continue into the blackout period, if you want to be sure no merges occur during a time period you should make the blackout period start earlier. This is especially true for merges that might run a long time.</Body>
<Body>
<A ID="pgfId-1045912"></A>
If the system determines that a merge is required and it is during a blackout period, the merge will not begin until the blackout period is past.</Body>
<Heading-3>
<A ID="pgfId-1046758"></A>
<A ID="64592"></A>
Configuring Merge Blackout Periods</Heading-3>
<Body>
<A ID="pgfId-1047138"></A>
Perform the following to configure merge blackout periods:</Body>
<Number1>
<A ID="pgfId-1047139"></A>
In the Admin Interface tree menu, click the Databases &gt; <Emphasis>
db_name</Emphasis>
 link, where <Emphasis>
db_name</Emphasis>
 is the name of the database in which you want to specify merge blackout periods.</Number1>
<NumberList>
<Number>
<A ID="pgfId-1047157"></A>
Click the Merge Policy menu item under your database. The Merge Policy Configuration page appears.</Number>
<Number>
<A ID="pgfId-1047178"></A>
Click the Create tab. The Add Merge Blackout page appears.</Number>
</NumberList>
<Body-indent>
<A ID="pgfId-1047179"></A>
<IMAGE xml:link="simple" href="images/merge_blackouts.gif" show="embed" actuate="auto"/>
</Body-indent>
<NumberList>
<Number>
<A ID="pgfId-1047180"></A>
Fill in the form as needed for the blackout period you want to create. Clicking the radio buttons will bring up more forms to complete.</Number>
<Number>
<A ID="pgfId-1047188"></A>
Click OK to create the blackout period.</Number>
</NumberList>
<EndList-root>
<A ID="pgfId-1047189"></A>
The new blackout period will take effect immediately.</EndList-root>
<Heading-3>
<A ID="pgfId-1047199"></A>
<A ID="23342"></A>
Deleting Merge Blackout Periods</Heading-3>
<Body>
<A ID="pgfId-1047203"></A>
Perform the following to delete a merge blackout period:</Body>
<Number1>
<A ID="pgfId-1047213"></A>
In the Admin Interface tree menu, click the Databases &gt; <Emphasis>
db_name</Emphasis>
 link, where <Emphasis>
db_name</Emphasis>
 is the name of the database in which you want to delete a merge blackout period.</Number1>
<NumberList>
<Number>
<A ID="pgfId-1047214"></A>
Click the Merge Policy menu item under your database. The Merge Policy Configuration page appears.</Number>
<Number>
<A ID="pgfId-1047226"></A>
In the area corresponding to the blackout period you want to delete, click the Delete button.</Number>
<Number>
<A ID="pgfId-1047233"></A>
Click OK on the confirmation page to delete the blackout period.</Number>
</NumberList>
<EndList-root>
<A ID="pgfId-1047235"></A>
The blackout period is deleted immediately.</EndList-root>
<Heading-2>
<A ID="pgfId-1045702"></A>
<A ID="55318"></A>
Merges and Point-In-Time Queries</Heading-2>
<Body>
<A ID="pgfId-1045706"></A>
When a merge occurs, it deletes all fragments from the stands being merged that have a system timestamp older than the configured <code>
merge timestamp</code>
 (unless the <code>
merge timestamp</code>
 is set to 0, in which case it will delete all fragments older than the current timestamp). This can keep multiple versions of some fragments in the database. You can query the older fragments using point-in-time queries. For details, see the chapter on 'Point-In-Time Queries' in the <Emphasis>
Application Developer's Guide</Emphasis>
.</Body>
<Heading-2>
<A ID="pgfId-1045675"></A>
<A ID="89673"></A>
Monitoring a Merge</Heading-2>
<Body>
<A ID="pgfId-1046843"></A>
There are two main places to look for monitoring information about merges:</Body>
<Body-bullet>
<A ID="pgfId-1046844"></A>
<A href="merges.xml#id(69288)" xml:link="simple" show="replace" actuate="user" CLASS="XRef"><Hyperlink>
Messages in the ErrorLog.txt File</Hyperlink>
</A></Body-bullet>
<Body-bullet>
<A ID="pgfId-1046849"></A>
<A href="merges.xml#id(38907)" xml:link="simple" show="replace" actuate="user" CLASS="XRef"><Hyperlink>
Database Status Page</Hyperlink>
</A></Body-bullet>
<Heading-3>
<A ID="pgfId-1046845"></A>
<A ID="69288"></A>
Messages in the ErrorLog.txt File</Heading-3>
<Body>
<A ID="pgfId-1046902"></A>
MarkLogic Server logs INFO level messages to the <code>
ErrorLog.txt</code>
 file whenever a merge begins, completes, or is canceled. Additionally, there are other log messages that are logged at more detail logging levels during a merge. The following are some sample log messages for a typical merge:</Body>
<Code>
<A ID="pgfId-1046909"></A>
2006-04-20 13:43:11.151 Info: Merging /var/opt/MarkLogic/Forests/bill/00000004 and /var/opt/MarkLogic/Forests/bill/00000005 to /var/opt/MarkLogic/Forests/bill/00000006
2006-04-20 13:43:15.726 Debug: OnDiskStand /var/opt/MarkLogic/Forests/bill/00000006, disk=47MB, memory=20MB
2006-04-20 13:43:15.726 Info: Merged 81 MB in 4 s at 20 MB/s to /var/opt/MarkLogic/Forests/bill/00000006
2006-04-20 13:43:15.806 Debug: ~OnDiskStand /var/opt/MarkLogic/Forests/bill/00000004
2006-04-20 13:43:15.806 Debug: ~OnDiskStand /var/opt/MarkLogic/Forests/bill/00000005
2006-04-20 13:43:15.859 Info: Deleted /var/opt/MarkLogic/Forests/bill/000000042006-04-20 13:43:15.894 Info: Deleted /var/opt/MarkLogic/Forests/bill/00000005</Code>
<Body>
<A ID="pgfId-1046938"></A>
If you cancel a merge, you will see an message similar to the following in the <code>
ErrorLog.txt</code>
 file:</Body>
<Code>
<A ID="pgfId-1047402"></A>
2006-05-08 17:45:44.027 Error: PooledThread::run: XDMP-CANCELED: Canceled merge of stands: 13419435601900621379, 6182944041533805976 to: C:\Program Files\MarkLogic\Data\Forests\bill\0000009a</Code>
<Body>
<A ID="pgfId-1047401"></A>
By examining the <code>
ErrorLog.txt</code>
 file, you can determine when a merge started, when it completed, which stands where merged together, what stand they were merged into, the size of the merge, and other useful information.</Body>
<Note>
<A ID="pgfId-1047718"></A>
There must be sufficient disk space on the file system in which the forest data is stored for a merge to complete successfully; if a merge runs out of disk space, it will fail with an error message. Also, there must be sufficient disk space on the file system in which the log files reside to log any activity on the system. If there is no space left on the log file device, MarkLogic Server will abort. Additionally, if there is no disk space available to add messages to the log files, MarkLogic Server will fail to start.</Note>
<Heading-3>
<A ID="pgfId-1046905"></A>
<A ID="38907"></A>
Database Status Page</Heading-3>
<Body>
<A ID="pgfId-1046981"></A>
You can access the Database Status page by clicking the Databases &gt; <Emphasis>
db_name</Emphasis>
 link in the tree menu, then clicking the Status tab in the Admin Interface. The Database Status page lists the merge state, which indicates if a merge is going on, shows the size of the merge, and estimates how long it will take the merge to complete. Additionally, the Database Status page includes a link to cancel the current merge (for details, see <A href="merges.xml#id(60776)" xml:link="simple" show="replace" actuate="user" CLASS="XRef">'Cancelling a Merge' on page&#160;148</A>).</Body>
<Heading-2>
<A ID="pgfId-1046986"></A>
<A ID="14662"></A>
Explicit Merge Commands</Heading-2>
<Body>
<A ID="pgfId-1046504"></A>
This section describes how to manually perform the following operations:</Body>
<Body-bullet>
<A ID="pgfId-1046509"></A>
<A href="merges.xml#id(23498)" xml:link="simple" show="replace" actuate="user" CLASS="XRef"><Hyperlink>
Manually Initiating a Merge</Hyperlink>
</A></Body-bullet>
<Body-bullet>
<A ID="pgfId-1046517"></A>
<A href="merges.xml#id(60776)" xml:link="simple" show="replace" actuate="user" CLASS="XRef"><Hyperlink>
Cancelling a Merge</Hyperlink>
</A></Body-bullet>
<Heading-3>
<A ID="pgfId-1046505"></A>
<A ID="23498"></A>
Manually Initiating a Merge</Heading-3>
<Body>
<A ID="pgfId-1046625"></A>
You can manually initiate a merge, either by explicitly issuing the <code>
xdmp:merge</code>
 command as described in <A href="../AdminAPI/maintenance.xml#id(82745)" xml:link="simple" show="replace" actuate="user" CLASS="XRef"><Hyperlink>
Merging the Forests in a Database</Hyperlink>
</A> in the <Emphasis>
Scripting Administrative Tasks Guide</Emphasis>
, or by clicking the Merge button on the database configuration page of the Admin Interface. Either of these actions will immediately begin a merge on the database (if using <code>
xdmp:merge</code>
, on the database to which the App Server that responds to the request is connected, or if using the Admin Interface, the database being configured). Manually initiated merges continue even when merges are disabled for a database. </Body>
<Body>
<A ID="pgfId-1046557"></A>
When you issue an <code>
xdmp:merge</code>
 command or click the Merge button, it will ignore all of the merge control settings and merge all of the on-disk stands down to a single stand. This is different from automatic merges, where merges only occur if they meet the specifications set forth in the parameters for the database being merged. </Body>
<Note>
<A ID="pgfId-1046568"></A>
If you have updates occurring on the system while a merge is in progress, the new fragments will not be merged during the active merge operation; they will be merged during a subsequent merge.</Note>
<Body>
<A ID="pgfId-1046553"></A>
Manually initiating a merge is useful when you have your merge controls set such that very large merges do not occur (for example, <code>
merge min ratio</code>
 set to 1), but you want to run the large merges during a period of low activity on your system.</Body>
<Body>
<A ID="pgfId-1047734"></A>
The <code>
xdmp:merge</code>
 API also allows you to specify options to the merge to control the maximum merge size, the forests which are merged, as well as other options. For details, see the <Emphasis>
MarkLogic XQuery and XSLT Function Reference</Emphasis>
.</Body>
<Heading-3>
<A ID="pgfId-1046487"></A>
<A ID="60776"></A>
Cancelling a Merge</Heading-3>
<Body>
<A ID="pgfId-1046585"></A>
You can cancel a merge in the Database Status page of the Admin Interface (Databases &gt; <Emphasis>
db_name</Emphasis>
 &gt; Status tab). If you access the status page for a database during a merge, on the part of the status page for the stand(s) being merged, there is a cancel button (usually on the bottom right of the status page).</Body>
<Body>
<A ID="pgfId-1046586"></A>
<IMAGE xml:link="simple" href="images/merge_cancel.gif" show="embed" actuate="auto"/>
</Body>
<Body>
<A ID="pgfId-1046587"></A>
When you cancel a merge, the new stand that has not completed its merge is discarded, leaving the unmerged stands as they were before the merge began. Note that if you cancel an automatic merge, it might start up a new merge as soon as it is canceled (if the merge controls are set such that a merge is triggered). To avoid this situation, you can change some of the merge control parameters before you cancel an automatic merge.</Body>
<Body>
<A ID="pgfId-1046647"></A>
To cancel a merge:</Body>
<Number1>
<A ID="pgfId-1046596"></A>
Click the Databases menu item in the Admin Interface.</Number1>
<NumberList>
<Number>
<A ID="pgfId-1046607"></A>
Click the name of the database, either from the tree menu or from the summary page.</Number>
<Number>
<A ID="pgfId-1046608"></A>
Click the Status tab.</Number>
<Number>
<A ID="pgfId-1046609"></A>
At the bottom right of the Database Status page, click the cancel button on the row for the stand being merged.</Number>
<Number>
<A ID="pgfId-1046612"></A>
Click OK on the Cancel Merge confirmation page.</Number>
</NumberList>
<EndList-root>
<A ID="pgfId-1046613"></A>
The merge is canceled and the Database Status page appears again.</EndList-root>
<Heading-2>
<A ID="pgfId-1046495"></A>
<A ID="66176"></A>
Configuring Merge Policy Rules</Heading-2>
<Body>
<A ID="pgfId-1045665"></A>
By changing some of the merge policy parameters, you can effectively control certain aspects of your merges. The descriptions in <A href="merges.xml#id(55008)" xml:link="simple" show="replace" actuate="user" CLASS="XRef">'Description on Merge Parameters' on page&#160;141</A> describes what each parameter does. This section describes some scenarios with suggestions for how to tune the merge control parameters to satisfy the conditions. It includes the following parts:</Body>
<Body-bullet>
<A ID="pgfId-1046765"></A>
<A href="merges.xml#id(58737)" xml:link="simple" show="replace" actuate="user" CLASS="XRef"><Hyperlink>
Determine the Baseline for Your Merges</Hyperlink>
</A></Body-bullet>
<Body-bullet>
<A ID="pgfId-1046828"></A>
<A href="merges.xml#id(39419)" xml:link="simple" show="replace" actuate="user" CLASS="XRef"><Hyperlink>
If You Want to Reduce the Number of ‘Large' Merges</Hyperlink>
</A></Body-bullet>
<Body-bullet>
<A ID="pgfId-1046769"></A>
<A href="merges.xml#id(84598)" xml:link="simple" show="replace" actuate="user" CLASS="XRef"><Hyperlink>
Other Solutions</Hyperlink>
</A></Body-bullet>
<Heading-3>
<A ID="pgfId-1046770"></A>
<A ID="58737"></A>
Determine the Baseline for Your Merges</Heading-3>
<Body>
<A ID="pgfId-1046788"></A>
The merge characteristics of your system depend on many factors, including the size of your forests, the amount of update activity on the system, and the way your data is fragmented. If you feel you need to change the configuration of your merges, the first step is to determine the merge characteristics for your database. This requires running your system under normal loads, then analyzing the log files to determine the following about your merges:</Body>
<Body-bullet>
<A ID="pgfId-1046801"></A>
average size of the merges</Body-bullet>
<Body-bullet>
<A ID="pgfId-1046805"></A>
average frequency of the merges</Body-bullet>
<Body-bullet>
<A ID="pgfId-1046806"></A>
average time it takes for the merges to complete</Body-bullet>
<Body>
<A ID="pgfId-1046807"></A>
If it turns out that your merges are never taking more than a few minutes to complete, then there is probably no need to change any of your settings. </Body>
<Heading-3>
<A ID="pgfId-1046787"></A>
<A ID="39419"></A>
If You Want to Reduce the Number of ‘Large' Merges</Heading-3>
<Body>
<A ID="pgfId-1046774"></A>
In most cases, MarkLogic Server will perform relatively small merges just often enough to keep the system properly optimized. Small merges are generally not very disruptive and reasonably fast. In some cases, however, you might find that your merges are too large and are taking too much time. Exactly how large constitutes a 'Large' merge is difficult to measure, but if you determine that your merges are too large, then you might want to try and configure your settings to avoid a really large merge. </Body>
<Body>
<A ID="pgfId-1051071"></A>
One way to avoid large merges is to set the <code>
merge max size</code>
 value. If you do set this value, however, you should only set it to a value as a temporary way to control your maximum merge size, as it can lead to a state where the database really needs to perform a large merge but cannot. Such a situation can lead to a poorly optimized system. One way to think about large merges is to compare them to sleeping for people; a person can go without much sleep for relatively short periods of time (a day or two or maybe even three for some people), but eventually, the person needs sleep or else he begins to function extremely poorly. Similarly, if a database is growing, it will eventually need to perform a large merge. Also, be careful not to set <code>
merge max size</code>
 to such a small value that you end up with a very large number of stands. Always use care when setting the <code>
merge max size</code>
 value, as you might end up with a large number of stands in your database, which can cause it to perform poorly and, when it reaches the maximum number of stands (64), will cause it to go offline. </Body>
<Body>
<A ID="pgfId-1047003"></A>
Another way to accomplish a goal of reducing the number of large merges is to lower the value for <code>
merge min ratio</code>
 to&#160;1. A value of 1 for <code>
merge min ratio</code>
 will not stop large merges from happening, but will make large merges only occur when the number of fragments in your largest stand is equal to the number of fragments in all of the other stands combined. Therefore, the only time merges will be more than 1/2 the size of your forest is when the fragment count of the sum of all but the largest stand is equal to or greater than the fragment count of the largest stand. To illustrate this, consider a forest with the following scenario:</Body>
<Body>
<A ID="pgfId-1047015"></A>
<IMAGE xml:link="simple" href="merges-3.gif" show="embed" actuate="auto"/>
</Body>
<Body>
<A ID="pgfId-1047016"></A>
If the <code>
merge min ratio</code>
 is set to&#160;1, then a stand can merge if the following ratio is less than 1:</Body>
<Body>
<A ID="pgfId-1047061"></A>
<IMAGE xml:link="simple" href="merges-4.gif" show="embed" actuate="auto"/>
</Body>
<Body>
<A ID="pgfId-1047062"></A>
Substituting in the values from the example for stand 1 yields:</Body>
<Code>
<A ID="pgfId-1047076"></A>
10000/(5000 + 1000 + 500) = 10000/6500 = 1.54</Code>
<Body>
<A ID="pgfId-1047077"></A>
which is greater than 1. Therefore stand 1 is not merged. Next putting in the values for stand 2 yields:</Body>
<Code>
<A ID="pgfId-1047091"></A>
5000/(1000 + 500) = 5000/1500 = 3.33</Code>
<Body>
<A ID="pgfId-1051235"></A>
which is greater than 1. Therefore stand 2 is not merged. Next putting in the values for stand 3 yields:</Body>
<Code>
<A ID="pgfId-1051236"></A>
1000/500 = 2.0</Code>
<Body>
<A ID="pgfId-1051253"></A>
which is greater than 1. Therefore stand 3 is not merged. Therefore, if the forest remains in a steady state (that is, no new content is added), then a <code>
merge min ratio</code>
 of 1 will cause this forest to not be merged.</Body>
<Body>
<A ID="pgfId-1051258"></A>
Now, consider that a load is happening during this time and a stand that has 501 fragments is saved into the forest. The result is 5 stands as follows:</Body>
<Body>
<A ID="pgfId-1051262"></A>
<IMAGE xml:link="simple" href="merges-5.gif" show="embed" actuate="auto"/>
</Body>
<Body>
<A ID="pgfId-1051259"></A>
Now, substituting in the values for stand 3 yields:</Body>
<Code>
<A ID="pgfId-1051300"></A>
1000/(500 + 501) = 1000/1001 = 0.99</Code>
<Body>
<A ID="pgfId-1051233"></A>
which is less than 1. Therefore stand 3 is merged. Note that stands 4 and 5 are smaller than stand 3, so the sum of the fragments in those stands appear in the denominator of the <code>
merge min ratio</code>
. Therefore stands 3, 4, and 5 are merged. Therefore, a <code>
merge min ratio</code>
 of 1 will cause this forest to be merged down to 3 stands, where stands 1 and 2 remain unmerged and stands 3, 4, and 5 are merged together into a new stand. The stands will now look as follows:</Body>
<Body>
<A ID="pgfId-1051112"></A>
<IMAGE xml:link="simple" href="merges-6.gif" show="embed" actuate="auto"/>
</Body>
<Body>
<A ID="pgfId-1051208"></A>
Note that, in a real world scenario with relatively large forests, this scenario (where the sum of the smaller stands fragment counts have as many fragments as the largest stand) will not happen very often, but will happen occasionally. For example, if another 3,000 fragments continued to accumulate in this forest, then stand 1 would merge with the other stands. </Body>
<Heading-3>
<A ID="pgfId-1046811"></A>
<A ID="84598"></A>
Other Solutions</Heading-3>
<Body>
<A ID="pgfId-1046815"></A>
In some cases, changing the merge parameters might not be the best solution for your system. For example, if your merges are taking a very long time due to slow disk drives or other system contention, addressing those issues might do more to help your merge times than any amount of tuning can do. Also, if your merges are extremely large, it could be that the forests are larger than optimal. There is no fixed maximum size for a forest, but experience in the field has shown that when forests grow over 200GB, query performance tends to start to decrease while merge times tend to start to increase. If your forests are larger than 200GB, consider breaking them into multiple forests.</Body>
</XML>
